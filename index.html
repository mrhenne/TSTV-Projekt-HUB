<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testsieger TV | Pro Hub</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        deepBlue: '#050A15',
                        slateGray: '#1E293B',
                        cyanAccent: '#00F0FF',
                        purpleAccent: '#B026FF',
                        brandOrange: '#FF7B00',
                        lightBg: '#F8FAFC'
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow-pulse': 'glow 2s ease-in-out infinite alternate',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        glow: {
                            '0%': { opacity: 0.6, boxShadow: '0 0 10px rgba(0,240,255,0.4)' },
                            '100%': { opacity: 1, boxShadow: '0 0 25px rgba(0,240,255,0.9), 0 0 40px rgba(176,38,255,0.6)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(100%)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 }
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(100,100,100,0.3); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
        ::-webkit-scrollbar-thumb:hover { background: #FF7B00; }
        
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.3));
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .dark .glass-panel {
            background: linear-gradient(135deg, rgba(20, 25, 40, 0.6), rgba(10, 15, 25, 0.4));
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .bg-mesh {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background-color: #E2E8F0;
            overflow: hidden;
            transition: background-color 0.3s;
        }
        .dark .bg-mesh {
            background-color: #050A15;
        }
        .bg-mesh::before, .bg-mesh::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.2;
            animation: blob 15s infinite alternate;
        }
        .bg-mesh::before { background: #B026FF; width: 50vw; height: 50vw; top: -10vw; left: -10vw; }
        .bg-mesh::after { background: #FF7B00; width: 40vw; height: 40vw; bottom: -5vw; right: -10vw; animation-delay: -5s; }

        .recording-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="text-slate-900 dark:text-slate-100 transition-colors duration-300 overflow-hidden font-sans">
    
    <div class="bg-mesh"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- ICONS ---
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path></svg>;
        const IconGrip = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="cursor-grab text-slate-400 dark:text-white/30 hover:text-brandOrange"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;
        const IconData = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>;
        const IconCompare = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><path d="M13 6h3a2 2 0 0 1 2 2v7"></path><line x1="6" y1="9" x2="6" y2="21"></line></svg>;
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const IconChevronDown = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const IconCamera = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>;
        const IconMoon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>;
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const IconCheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const IconMenu = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
        const IconBook = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const IconTarget = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle><line x1="12" y1="2" x2="12" y2="5"></line><line x1="12" y1="19" x2="12" y2="22"></line><line x1="2" y1="12" x2="5" y2="12"></line><line x1="19" y1="12" x2="22" y2="12"></line></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconCheckDouble = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 7 17l-5-5"></path><path d="m22 10-7.5 7.5L13 16"></path></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const IconPause = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const IconStop = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>;
        const IconMic = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>;
        const IconSandglass = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 2h14"></path><path d="M5 22h14"></path><path d="M6 2v6.7a6 6 0 0 0 3 5.2l3 1.7-3 1.7a6 6 0 0 0-3 5.2V22"></path><path d="M18 2v6.7a6 6 0 0 1-3 5.2l-3 1.7 3 1.7a6 6 0 0 1 3 5.2V22"></path></svg>;

        // --- BRAND LOGO COMPONENT (OLD SVG LOGO) ---
        const BrandLogo = () => (
            <div className="flex items-center gap-2 select-none pointer-events-none">
                <svg width="44" height="28" viewBox="0 0 100 60" fill="none" stroke="#FF7B00" strokeWidth="5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M 30 20 L 70 20 L 60 30 L 40 30 Z" fill="#FF7B00" />
                    <line x1="8" y1="14" x2="35" y2="14" />
                    <line x1="65" y1="14" x2="92" y2="14" />
                    <line x1="20" y1="14" x2="20" y2="22" />
                    <line x1="80" y1="14" x2="80" y2="22" />
                    <path d="M 40 30 L 25 45 M 60 30 L 75 45" />
                    <line x1="20" y1="45" x2="30" y2="45" />
                    <line x1="70" y1="45" x2="80" y2="45" />
                    <rect x="38" y="36" width="24" height="18" rx="4" fill="none" />
                    <polygon points="46,40 56,45 46,50" fill="#FF7B00" stroke="none" />
                </svg>
                <div className="flex flex-col justify-center leading-none mt-1">
                    <span className="text-brandOrange font-black text-[11px] tracking-widest uppercase" style={{ letterSpacing: '0.15em' }}>Test</span>
                    <div className="flex items-center gap-1.5 -mt-0.5">
                        <span className="text-slate-900 dark:text-white font-black text-xl tracking-tight leading-none">SIEGER</span>
                        <span className="bg-brandOrange text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md leading-none">TV</span>
                    </div>
                </div>
            </div>
        );

        // --- DYNAMIC CONFIG & TEMPLATES ---
        const INITIAL_CATEGORIES = [
            { id: 'saugroboter', name: 'Saugroboter' },
            { id: 'rasenmaehroboter', name: 'Rasenmähroboter' },
            { id: 'smarthome', name: 'Smarthome' },
            { id: 'technik', name: 'Technik generell' }
        ];

        const WORKFLOWS = {
            saugroboter: {
                checklist: [
                    { phase: "Phase 1: Vorbereitung", items: [{ text: "Auspacken: Inhalt prüfen" }, { text: "Lieferumfang notieren" }, { text: "Design/Haptik bewerten" }] },
                    { phase: "Phase 2: Einrichtung und App", items: [{ text: "Station aufstellen" }, { text: "App Kopplung" }, { text: "Erste Kartierung", defaultMeasurements: "Kartierungsdauer (Minuten): \nRaumaufteilung korrekt?: " }] },
                    { phase: "Phase 3: Navigation", items: [{ text: "Test Parcours (groß/klein)", defaultMeasurements: "5 große Hindernisse:\nBerührt: \n\n5 kleine Hindernisse:\nBerührt: " }] },
                    { phase: "Phase 4: Saugleistung", items: [{ text: "Hartboden Test", defaultMeasurements: "1. Durchgang: \n2. Durchgang: " }, { text: "Teppich Test (50g)", defaultMeasurements: "Verteilt: 50g\nAufgenommen: g\nQuote: %" }] },
                    { phase: "Phase 5: Wischleistung", items: [{ text: "Wischtest (Kaffee/Ketchup)", defaultMeasurements: "1. Durchgang: \n2. Durchgang: \n4. Durchgang: " }] }
                ],
                shotlist: [
                    { phase: "Phase 1: Vorbereitung", items: ["Karton offen", "Zubehör ausgelegt", "Roboter Frontal"] },
                    { phase: "Phase 2: Action", items: ["Roboter im Parcours", "Wischbild Detail"] }
                ],
                scores: { verarbeitung: 5, saugleistung: 5, wischleistung: 5, navigation: 5, app: 5, preis_leistung: 5 }
            },
            technik: {
                checklist: [{ phase: "Test", items: [{text: "Standardtest"}] }],
                shotlist: [{ phase: "Fotos", items: ["Produktbild"] }],
                scores: { leistung: 5, design: 5, preis_leistung: 5 }
            }
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- MAIN APP ---
        const App = () => {
            const [theme, setTheme] = useState(() => localStorage.getItem('ttv_theme') || 'dark');
            const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('ttv_categories')) || INITIAL_CATEGORIES);
            const [projects, setProjects] = useState(() => JSON.parse(localStorage.getItem('ttv_projects')) || []);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [activeTab, setActiveTab] = useState('checklist');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isFocusModeOpen, setIsFocusModeOpen] = useState(false);
            const [globalNotes, setGlobalNotes] = useState(() => localStorage.getItem('ttv_global_notes') || '');
            const [isLogbuchOpen, setIsLogbuchOpen] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);

            // STOPWATCH & TIMER STATE
            const [isTimerOpen, setIsTimerOpen] = useState(false);
            const [timerMode, setTimerMode] = useState('stopwatch'); // 'stopwatch' or 'countdown'
            const [isRunning, setIsRunning] = useState(false);
            const [time, setTime] = useState(0); // in seconds
            const [timerInput, setTimerInput] = useState(5); // initial countdown minutes

            // MODALS
            const [showNewProjectModal, setShowNewProjectModal] = useState(false);
            const [newProjectTitle, setNewProjectTitle] = useState('');
            const [newProjectCategory, setNewProjectCategory] = useState('saugroboter');
            const [projectToDelete, setProjectToDelete] = useState(null);

            const fileInputRef = useRef(null);

            // Theme Effect
            useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('ttv_theme', theme);
            }, [theme]);

            // Persist Data
            useEffect(() => {
                localStorage.setItem('ttv_categories', JSON.stringify(categories));
                localStorage.setItem('ttv_projects', JSON.stringify(projects));
                localStorage.setItem('ttv_global_notes', globalNotes);
            }, [categories, projects, globalNotes]);

            // STOPWATCH / TIMER LOGIC
            useEffect(() => {
                let interval;
                if (isRunning) {
                    interval = setInterval(() => {
                        if (timerMode === 'stopwatch') {
                            setTime(prev => prev + 1);
                        } else {
                            setTime(prev => {
                                if (prev <= 0) {
                                    setIsRunning(false);
                                    showToast("Timer abgelaufen!");
                                    return 0;
                                }
                                return prev - 1;
                            });
                        }
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning, timerMode]);

            const currentProject = projects.find(p => p.id === currentProjectId);

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(null), 3000);
            };

            const formatTime = (secs) => {
                const m = Math.floor(secs / 60).toString().padStart(2, '0');
                const s = (secs % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };

            const handleStartCountdown = () => {
                setTime(timerInput * 60);
                setIsRunning(true);
            };

            // DICTATION LOGIC
            const startDictation = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    showToast("Diktierfunktion wird nicht unterstützt.");
                    return;
                }
                const recognition = new SpeechRecognition();
                recognition.lang = 'de-DE';
                recognition.interimResults = false;

                recognition.onstart = () => setIsRecording(true);
                recognition.onend = () => setIsRecording(false);
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setGlobalNotes(prev => prev + (prev ? '\n' : '') + transcript);
                    showToast("Sprache erkannt.");
                };
                recognition.start();
            };

            const exportData = () => {
                const data = { projects, categories, globalNotes };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `TTV_Export_${new Date().toLocaleDateString()}.json`;
                a.click();
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.projects) setProjects(data.projects);
                        if (data.categories) setCategories(data.categories);
                        if (data.globalNotes) setGlobalNotes(data.globalNotes);
                        showToast("Daten importiert!");
                    } catch(e) { showToast("Fehler beim Import."); }
                };
                reader.readAsText(file);
            };

            const updateCurrentProject = (updates) => {
                setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, ...updates } : p));
            };

            const markPhaseDone = (listKey, phaseIndex, e) => {
                e.stopPropagation();
                const newList = [...currentProject[listKey]];
                newList[phaseIndex].items = newList[phaseIndex].items.map(item => ({ ...item, done: true }));
                updateCurrentProject({ [listKey]: newList });
                showToast("Phase abgehakt!");
            };

            return (
                <div className="flex h-screen overflow-hidden text-slate-800 dark:text-white transition-colors duration-300">
                    
                    {/* TOAST */}
                    {toastMessage && (
                        <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] bg-brandOrange text-white px-6 py-3 rounded-full font-bold shadow-2xl animate-slide-in">
                            {toastMessage}
                        </div>
                    )}

                    {/* SIDEBAR */}
                    <aside className={`fixed inset-y-0 left-0 z-40 transform transition-transform duration-300 w-[300px] glass-panel border-r border-slate-300/50 dark:border-white/10 flex flex-col bg-white/50 dark:bg-black/80 backdrop-blur-3xl ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-300/50 dark:border-white/10 flex justify-between items-center">
                            <BrandLogo />
                            <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded-full hover:bg-slate-200/50 dark:hover:bg-white/10">
                                {theme === 'dark' ? <IconSun /> : <IconMoon />}
                            </button>
                        </div>
                        
                        <div className="p-5">
                            <button onClick={() => setShowNewProjectModal(true)} className="w-full bg-brandOrange text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 hover:shadow-lg transition">
                                <IconPlus /> Neues Projekt
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto px-3 space-y-2">
                            {projects.map((p) => (
                                <div 
                                    key={p.id}
                                    onClick={() => setCurrentProjectId(p.id)}
                                    className={`group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${currentProjectId === p.id ? 'bg-brandOrange/10 border border-brandOrange/50' : 'hover:bg-white/40 dark:hover:bg-white/10'}`}
                                >
                                    <div className="truncate text-sm font-medium">{p.title}</div>
                                    <button onClick={(e) => {e.stopPropagation(); setProjectToDelete(p.id);}} className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition"><IconTrash /></button>
                                </div>
                            ))}
                        </div>

                        <div className="p-4 border-t border-slate-300/50 dark:border-white/10 bg-slate-100/50 dark:bg-black/40">
                            <div className="flex gap-2">
                                <button onClick={exportData} className="flex-1 bg-white/50 dark:bg-white/10 py-2 rounded-lg text-xs font-bold border border-slate-300/50 dark:border-white/10 flex flex-col items-center gap-1 hover:bg-white dark:hover:bg-white/20">
                                    <IconDownload /> Backup
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="flex-1 bg-white/50 dark:bg-white/10 py-2 rounded-lg text-xs font-bold border border-slate-300/50 dark:border-white/10 flex flex-col items-center gap-1 hover:bg-white dark:hover:bg-white/20">
                                    <IconUpload /> Import
                                </button>
                                <input type="file" ref={fileInputRef} onChange={importData} className="hidden" />
                            </div>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className={`flex-1 flex flex-col h-full relative transition-all duration-300 ${isSidebarOpen ? 'md:ml-[300px]' : 'ml-0'}`}>
                        {currentProject ? (
                            <>
                                <header className="h-20 border-b border-slate-300/50 dark:border-white/10 px-6 flex items-center justify-between glass-panel !border-none !rounded-none">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition"><IconMenu /></button>
                                        <h2 className="text-2xl font-bold">{currentProject.title}</h2>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <button onClick={() => setIsFocusModeOpen(true)} className="px-4 py-2 rounded-lg bg-slate-900 text-cyanAccent border border-cyanAccent/30 text-sm font-bold flex items-center gap-2 hover:bg-black transition"><IconTarget /> Labor-Modus</button>
                                    </div>
                                </header>

                                <div className="flex-1 overflow-auto p-8">
                                    <div className="max-w-4xl mx-auto space-y-8">
                                        {/* Phases rendering */}
                                        {currentProject.checklist.map((phase, pIdx) => (
                                            <div key={pIdx} className="glass-panel rounded-2xl overflow-hidden">
                                                <div className="bg-slate-100/50 dark:bg-white/5 p-4 flex justify-between items-center">
                                                    <h3 className="font-bold text-lg">{phase.phase}</h3>
                                                    <button 
                                                        onClick={(e) => markPhaseDone('checklist', pIdx, e)}
                                                        className="text-[10px] font-bold uppercase tracking-widest bg-green-500/20 text-green-600 px-3 py-1 rounded-md border border-green-500/30 hover:bg-green-500 hover:text-white transition"
                                                    >
                                                        <IconCheckDouble /> Alles abhaken
                                                    </button>
                                                </div>
                                                <div className="p-4 space-y-2">
                                                    {phase.items.map((item, iIdx) => (
                                                        <div key={iIdx} className="flex items-center gap-3 p-2 hover:bg-white/20 dark:hover:bg-white/5 rounded-lg transition">
                                                            <input type="checkbox" checked={item.done} onChange={(e) => {
                                                                const newList = [...currentProject.checklist];
                                                                newList[pIdx].items[iIdx].done = e.target.checked;
                                                                updateCurrentProject({ checklist: newList });
                                                            }} className="w-5 h-5 accent-cyanAccent" />
                                                            <span className={item.done ? 'line-through text-slate-400' : ''}>{item.text}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center opacity-40">
                                <BrandLogo />
                                <p className="mt-4">Wähle ein Projekt aus.</p>
                            </div>
                        )}
                    </main>

                    {/* FLOATING TIMER WIDGET (REPOSITIONED TO AVOID OVERLAPPING SIDEBAR) */}
                    <div className="fixed bottom-8 right-24 z-50 flex flex-col items-end gap-3">
                        {isTimerOpen && (
                            <div className="glass-panel p-5 rounded-3xl shadow-2xl w-64 border border-brandOrange/30 animate-slide-in bg-white/95 dark:bg-black/90">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex gap-2 bg-slate-200 dark:bg-black/50 p-1 rounded-lg">
                                        <button onClick={() => setTimerMode('stopwatch')} className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${timerMode === 'stopwatch' ? 'bg-brandOrange text-white' : ''}`}>Uhr</button>
                                        <button onClick={() => setTimerMode('countdown')} className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${timerMode === 'countdown' ? 'bg-brandOrange text-white' : ''}`}>Timer</button>
                                    </div>
                                    <button onClick={() => setIsTimerOpen(false)} className="text-slate-400 hover:text-white"><IconX /></button>
                                </div>

                                <div className={`text-4xl font-mono font-black text-center mb-6 tracking-tighter ${isRunning ? 'text-cyanAccent animate-pulse' : 'text-slate-400'}`}>
                                    {formatTime(time)}
                                </div>

                                {timerMode === 'countdown' && !isRunning && (
                                    <div className="mb-4">
                                        <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Dauer (Minuten)</label>
                                        <input 
                                            type="number" 
                                            value={timerInput} 
                                            onChange={(e) => setTimerInput(e.target.value)}
                                            className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm outline-none focus:border-brandOrange text-white"
                                        />
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    {!isRunning ? (
                                        <button 
                                            onClick={() => timerMode === 'countdown' ? handleStartCountdown() : setIsRunning(true)}
                                            className="flex-1 bg-green-500 text-black py-3 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-green-400 transition"
                                        >
                                            <IconPlay /> Start
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={() => setIsRunning(false)}
                                            className="flex-1 bg-brandOrange text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-brandOrange/80 transition"
                                        >
                                            <IconPause /> Stop
                                        </button>
                                    )}
                                    <button 
                                        onClick={() => { setIsRunning(false); setTime(0); }}
                                        className="bg-slate-200 dark:bg-white/10 p-3 rounded-xl hover:bg-red-500 hover:text-white transition"
                                    >
                                        <IconStop />
                                    </button>
                                </div>
                            </div>
                        )}
                        {/* THE SMALL SYMBOL (RESIZED & PLACED RIGHT) */}
                        <button 
                            onClick={() => setIsTimerOpen(!isTimerOpen)}
                            className={`w-12 h-12 flex items-center justify-center rounded-full shadow-2xl transition-all hover:scale-110 active:scale-95 ${isRunning ? 'bg-brandOrange text-white' : 'bg-slate-900 dark:bg-white text-white dark:text-black'}`}
                            title="Timer / Stoppuhr"
                        >
                            {timerMode === 'stopwatch' ? <IconClock /> : <IconSandglass />}
                        </button>
                    </div>

                    {/* LOGBUCH BUTTON */}
                    <button 
                        onClick={() => setIsLogbuchOpen(true)}
                        className={`fixed bottom-8 right-8 z-40 bg-slate-900 dark:bg-white text-white dark:text-black p-4 rounded-full shadow-2xl hover:scale-110 transition ${isLogbuchOpen ? 'opacity-0 pointer-events-none' : ''}`}
                        title="Labor Logbuch"
                    >
                        <IconBook />
                    </button>

                    {/* LOGBUCH PANEL */}
                    <div className={`fixed inset-y-0 right-0 w-96 glass-panel border-l border-white/10 shadow-2xl z-50 transform transition-transform duration-300 flex flex-col bg-white/90 dark:bg-black/80 backdrop-blur-3xl ${isLogbuchOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="p-6 border-b border-white/10 flex justify-between items-center">
                            <h3 className="text-xl font-bold flex items-center gap-2"><IconBook /> Labor Logbuch</h3>
                            <button onClick={() => setIsLogbuchOpen(false)}><IconX /></button>
                        </div>
                        <div className="flex-1 p-6 flex flex-col">
                            <div className="mb-4 flex gap-2">
                                <button 
                                    onClick={startDictation}
                                    className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${isRecording ? 'bg-red-500 text-white recording-pulse' : 'bg-cyanAccent text-black hover:bg-cyanAccent/80'}`}
                                >
                                    <IconMic /> {isRecording ? 'Höre zu...' : 'Diktieren'}
                                </button>
                                <button 
                                    onClick={() => setGlobalNotes('')}
                                    className="p-3 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition"
                                    title="Alles löschen"
                                >
                                    <IconTrash />
                                </button>
                            </div>
                            <textarea 
                                value={globalNotes}
                                onChange={(e) => setGlobalNotes(e.target.value)}
                                className="flex-1 w-full bg-white/50 dark:bg-black/30 border border-white/10 rounded-xl p-4 text-sm outline-none focus:border-brandOrange resize-none leading-relaxed"
                                placeholder="Tippe hier oder nutze die Diktierfunktion..."
                            />
                        </div>
                    </div>

                    {/* NEW PROJECT MODAL */}
                    {showNewProjectModal && (
                        <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="glass-panel p-8 max-w-sm w-full rounded-3xl animate-slide-in">
                                <h3 className="text-xl font-bold mb-4">Projekt erstellen</h3>
                                <input value={newProjectTitle} onChange={e => setNewProjectTitle(e.target.value)} placeholder="Produktname" className="w-full bg-black/30 p-3 rounded-xl mb-4 border border-white/10 outline-none focus:border-brandOrange text-white" />
                                <select value={newProjectCategory} onChange={e => setNewProjectCategory(e.target.value)} className="w-full bg-black/30 p-3 rounded-xl mb-6 border border-white/10 outline-none text-white">
                                    <option value="saugroboter">Saugroboter</option>
                                    <option value="technik">Technik generell</option>
                                </select>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowNewProjectModal(false)} className="flex-1 py-3 text-slate-400">Abbruch</button>
                                    <button onClick={() => {
                                        const template = WORKFLOWS[newProjectCategory] || WORKFLOWS.technik;
                                        const newProj = { 
                                            id: generateId(), 
                                            title: newProjectTitle, 
                                            category: newProjectCategory, 
                                            status: 'draft', 
                                            timeSpent: 0, 
                                            createdAt: new Date().toISOString(), 
                                            checklist: template.checklist.map(c => ({
                                                ...c, 
                                                items: c.items.map(i => ({
                                                    ...i, 
                                                    id: generateId(), 
                                                    done: false,
                                                    measurements: i.defaultMeasurements || ''
                                                }))
                                            })), 
                                            shotlist: template.shotlist.map(s => ({
                                                ...s, 
                                                items: s.items.map(i => ({id: generateId(), text: i, done: false}))
                                            })), 
                                            scores: {...template.scores}, 
                                            data: {pros: [], cons: [], conditions: 'Firmware: \nTestdauer: '}, 
                                            comparison: {specs: [], predecessor: '', competitor: ''}
                                        };
                                        setProjects([...projects, newProj]);
                                        setCurrentProjectId(newProj.id);
                                        setShowNewProjectModal(false);
                                    }} className="flex-1 py-3 bg-brandOrange text-white rounded-xl font-bold">Erstellen</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
